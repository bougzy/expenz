<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Fintech App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Fintech App</a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a class="nav-link" href="logout.html">Logout</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="container mt-4">
        <h1>User Dashboard</h1>
        
        <!-- Bootstrap Tabs for Deposit, Withdrawal, and Feedback -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="deposit-tab" data-toggle="tab" href="#deposit" role="tab" aria-controls="deposit" aria-selected="true">Deposit</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="withdraw-tab" data-toggle="tab" href="#withdraw" role="tab" aria-controls="withdraw" aria-selected="false">Withdraw</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="feedback-tab" data-toggle="tab" href="#feedback" role="tab" aria-controls="feedback" aria-selected="false">Feedback</a>
            </li>
        </ul>
        
        <div class="tab-content" id="dashboardTabContent">
            <!-- Deposit Tab -->
            <div class="tab-pane fade show active" id="deposit" role="tabpanel" aria-labelledby="deposit-tab">
                <h4>Your Deposit History</h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Approved At</th>
                            <th>Proof of Payment</th>
                        </tr>
                    </thead>
                    <tbody id="depositHistory">
                        <!-- Deposit history will be injected here -->
                    </tbody>
                </table>
                <h4>Deposit Money</h4>
                <form id="depositForm">
                    <div class="form-group">
                        <label for="plan">Select Investment Plan</label>
                        <select class="form-control" id="plan" required>
                            <option value="" disabled selected>Select a plan</option>
                            <option value="Plan A">Plan A - 10% Return</option>
                            <option value="Plan B">Plan B - 15% Return</option>
                            <option value="Plan C">Plan C - 20% Return</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="walletAddress">Select Wallet Address</label>
                        <select class="form-control" id="walletAddress" required>
                            <option value="" disabled selected>Select a wallet address</option>
                            <option value="wallet_address_1">Wallet Address 1</option>
                            <option value="wallet_address_2">Wallet Address 2</option>
                            <option value="wallet_address_3">Wallet Address 3</option>
                        </select>
                        <button type="button" class="btn btn-outline-secondary mt-2" onclick="copyWalletAddress()">Copy Address</button>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <input type="number" class="form-control" id="amount" required>
                    </div>
                    <div class="form-group">
                        <label for="proof">Upload Proof of Payment</label>
                        <!-- <input type="file" class="form-control-file" id="proof" required> -->
                        <input type="file" class="form-control-file" id="proof" name="proofOfPayment" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Deposit</button>
                </form>
            </div>
            
            <!-- Withdraw Tab -->
            <div class="tab-pane fade" id="withdraw" role="tabpanel" aria-labelledby="withdraw-tab">
                <h4>Withdraw Money</h4>
                <form id="withdrawForm">
                    <div class="form-group">
                        <label for="withdrawAmount">Amount to Withdraw</label>
                        <input type="number" class="form-control" id="withdrawAmount" required>
                    </div>
                    <div class="form-group">
                        <label for="withdrawAddress">Wallet Address</label>
                        <input type="text" class="form-control" id="withdrawAddress" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Request Withdrawal</button>
                </form>
            </div>
            
            <!-- Feedback Tab -->
            <div class="tab-pane fade" id="feedback" role="tabpanel" aria-labelledby="feedback-tab">
                <h4>Submit Feedback</h4>
                <form id="feedbackForm">
                    <div class="form-group">
                        <label for="userEmail">Your Email</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="feedback">Your Feedback</label>
                        <textarea class="form-control" id="feedback" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Feedback</button>
                </form>
            </div>
    
            <!-- Your Investment Plans -->
            <h4>Your Investment Plans</h4>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Plan Name</th>
                        <th>Interest Rate</th>
                        <th>Duration</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="investmentPlans"></tbody>
            </table>
    
            <h4>Profit Notifications</h4>
            <div id="profitNotifications"></div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <script>
        async function fetchUserData() {
            const token = localStorage.getItem('token');
    
            const response = await fetch('/api/users/me', {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            });
    
            if (response.ok) {
                const user = await response.json();
                document.getElementById('userName').textContent = user.name;
                document.getElementById('balance').textContent = user.balance.toFixed(2);
                loadDepositHistory();
                loadInvestmentPlans();
            } else {
                alert('Failed to fetch user data');
            }
        }
    
        async function loadDepositHistory() {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/transactions/deposit', {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            });
    
            if (response.ok) {
                const deposits = await response.json();
                const depositHistory = document.getElementById('depositHistory');
                depositHistory.innerHTML = '';
    
                deposits.forEach(deposit => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${deposit.amount.toFixed(2)}</td>
                        <td>${deposit.status}</td>
                        <td>${deposit.approvedAt || 'Pending'}</td>
                        <td><a href="${deposit.proof}" target="_blank">View Proof</a></td>
                    `;
                    depositHistory.appendChild(tr);
                });
            } else {
                alert('Failed to load deposit history');
            }
        }
    
        async function loadInvestmentPlans() {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/investment-plans', {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            });
    
            if (response.ok) {
                const plans = await response.json();
                const investmentPlans = document.getElementById('investmentPlans');
                investmentPlans.innerHTML = '';
    
                plans.forEach(plan => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${plan.name}</td>
                        <td>${plan.interestRate}%</td>
                        <td>${plan.duration}</td>
                        <td><button class="btn btn-primary">Invest</button></td>
                    `;
                    investmentPlans.appendChild(tr);
                });
            } else {
                alert('Failed to load investment plans');
            }
        }
    
        document.getElementById('depositForm').addEventListener('submit', async (e) => {
            e.preventDefault();
    
            const amount = document.getElementById('amount').value;
            const plan = document.getElementById('plan').value;
            const walletAddress = document.getElementById('walletAddress').value;
            const proof = document.getElementById('proof').files[0];
    
            const formData = new FormData();
            formData.append('amount', amount);
            formData.append('plan', plan);
            formData.append('walletAddress', walletAddress);
            formData.append('proofOfPayment', proof);
    
            const response = await fetch('/api/transactions/deposit', {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`,
                },
                body: formData,
            });
    
            if (response.ok) {
                alert('Deposit submitted successfully');
                loadDepositHistory();
                document.getElementById('depositForm').reset();
            } else {
                alert('Failed to submit deposit');
            }
        });
    
        document.getElementById('withdrawForm').addEventListener('submit', async (e) => {
            e.preventDefault();
    
            const amount = document.getElementById('withdrawAmount').value;
            const withdrawAddress = document.getElementById('withdrawAddress').value;
    
            const response = await fetch('/api/transactions/withdraw', {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ amount, withdrawAddress }),
            });
    
            if (response.ok) {
                alert('Withdrawal request submitted successfully');
                document.getElementById('withdrawForm').reset();
            } else {
                alert('Failed to submit withdrawal request');
            }
        });
    
        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
    
            const email = document.getElementById('userEmail').value;
            const feedbackText = document.getElementById('feedback').value;
    
            const response = await fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, feedback: feedbackText }),
            });
    
            if (response.ok) {
                alert('Feedback submitted successfully');
                document.getElementById('feedbackForm').reset();
            } else {
                alert('Failed to submit feedback');
            }
        });
    
        function copyWalletAddress() {
            const walletSelect = document.getElementById('walletAddress');
            walletSelect.select();
            document.execCommand('copy');
            alert('Wallet address copied to clipboard!');
        }
    
        // Load user data on page load
        window.onload = fetchUserData;
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        async function fetchUserData() {
            const token = localStorage.getItem('token');

            const response = await fetch('/api/users/me', {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            });

            if (response.ok) {
                const user = await response.json();
                document.getElementById('userName').textContent = user.name;
                document.getElementById('balance').textContent = user.balance.toFixed(2);
                loadDepositHistory();
                loadInvestmentPlans();
            } else {
                alert('Failed to fetch user data');
            }
        }

        async function loadDepositHistory() {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/transactions/deposit', {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            });

            if (response.ok) {
                const deposits = await response.json();
                const depositHistory = document.getElementById('depositHistory');
                depositHistory.innerHTML = '';

                deposits.forEach(deposit => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${deposit.amount.toFixed(2)}</td>
                        <td>${deposit.status}</td>
                        <td>${deposit.approvedAt || 'Pending'}</td>
                        <td><a href="${deposit.proof}" target="_blank">View Proof</a></td>
                    `;
                    depositHistory.appendChild(tr);
                });
            } else {
                alert('Failed to load deposit history');
            }
        }

        async function loadInvestmentPlans() {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/investment-plans', {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            });

            if (response.ok) {
                const plans = await response.json();
                const investmentPlans = document.getElementById('investmentPlans');
                investmentPlans.innerHTML = '';

                plans.forEach(plan => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${plan.name}</td>
                        <td>${plan.interestRate}%</td>
                        <td>${plan.duration}</td>
                        <td><button class="btn btn-primary">Invest</button></td>
                    `;
                    investmentPlans.appendChild(tr);
                });
            } else {
                alert('Failed to load investment plans');
            }
        }

        document.getElementById('depositForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const amount = document.getElementById('amount').value;
            const plan = document.getElementById('plan').value;
            const walletAddress = document.getElementById('walletAddress').value;
            const proof = document.getElementById('proof').files[0];

            const formData = new FormData();
            formData.append('amount', amount);
            formData.append('plan', plan);
            formData.append('walletAddress', walletAddress);
            formData.append('proofOfPayment', proof);

            const response = await fetch('/api/transactions/deposit', {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`,
                },
                body: formData,
            });

            if (response.ok) {
                alert('Deposit submitted successfully');
                loadDepositHistory();
                document.getElementById('depositForm').reset();
            } else {
                alert('Failed to submit deposit');
            }
        });

        document.getElementById('withdrawForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const amount = document.getElementById('withdrawAmount').value;
            const withdrawAddress = document.getElementById('withdrawAddress').value;

            const response = await fetch('/api/transactions/withdraw', {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ amount, withdrawAddress }),
            });

            if (response.ok) {
                alert('Withdrawal request submitted successfully');
                document.getElementById('withdrawForm').reset();
            } else {
                alert('Failed to submit withdrawal request');
            }
        });

        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('userEmail').value;
            const feedbackText = document.getElementById('feedback').value;

            const response = await fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    Authorization: `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, feedback: feedbackText }),
            });

            if (response.ok) {
                alert('Feedback submitted successfully');
                document.getElementById('feedbackForm').reset();
            } else {
                alert('Failed to submit feedback');
            }
        });

        function copyWalletAddress() {
            const walletSelect = document.getElementById('walletAddress');
            walletSelect.select();
            document.execCommand('copy');
            alert('Wallet address copied to clipboard!');
        }

        // Load user data on page load
        window.onload = fetchUserData;
    </script>
</body>
</html>





// async function fetchUserData() {
    //     const token = localStorage.getItem('token'); // Fetch the token stored after login
    
    //     if (!token) {
    //         alert("User not authenticated, please login again.");
    //         window.location.href = '/login.html'; // Redirect to login page if no token
    //         return;
    //     }
    
    //     const response = await fetch('http://localhost:5000/api/users/me', {
    //         headers: {
    //             'Authorization': `Bearer ${token}`, // Correct format for sending the token
    //         },
    //     });
    
    //     if (response.ok) {
    //         const user = await response.json(); // Parse the response
    //         document.getElementById('userName').textContent = user.name;
    //         document.getElementById('userEmail').textContent = user.email;
    //         document.getElementById('balance').textContent = user.balance.toFixed(2);
    //         document.getElementById('profits').textContent = user.profits.toFixed(2);
    //     } else if (response.status === 403) {
    //         alert("Forbidden: Invalid token or session expired.");
    //         localStorage.removeItem('token'); // Clear invalid token
    //         window.location.href = '/login.html'; // Redirect to login
    //     } else {
    //         alert('Failed to fetch user data');
    //     }
    // }
    
    //  // Call fetchUserData when the page loads
    //         fetchUserData();
    
    
    // let previousProfit = 0;
    
    // // Function to fetch user data from the server
    // async function fetchUserData() {
    //     const token = localStorage.getItem('token');
    
    //     if (!token) {
    //         alert("User not authenticated, please login again.");
    //         window.location.href = '/login.html'; // Redirect to login page if no token
    //         return;
    //     }
    
    //     const response = await fetch('http://localhost:5000/api/users/me', {
    //         headers: {
    //             'Authorization': `Bearer ${token}`,
    //         },
    //     });
    
    //     if (response.ok) {
    //         const user = await response.json();
    
    //         // Update the user details in the UI
    //         document.getElementById('userName').textContent = user.name;
    //         document.getElementById('userEmail').textContent = user.email;
    //         document.getElementById('balance').textContent = user.balance.toFixed(2);
    //         document.getElementById('profits').textContent = user.profits.toFixed(2);
    
    //         // Check if profit has increased
    //         if (user.profits > previousProfit) {
    //             alert(`Your profits have increased! New profit: $${user.profits.toFixed(2)}`);
    //         }
    
    //         // Update previous profit for comparison in the next fetch
    //         previousProfit = user.profits;
    
    //     } else if (response.status === 403) {
    //         alert("Forbidden: Invalid token or session expired.");
    //         localStorage.removeItem('token');
    //         window.location.href = '/login.html';
    //     } else {
    //         alert('Failed to fetch user data');
    //     }
    // }
    
    // // WebSocket connection for real-time profit updates
    // const socket = new WebSocket('ws://localhost:5000');
    
    // socket.onopen = function () {
    //     console.log('Connected to WebSocket server');
    // };
    
    // socket.onmessage = function (event) {
    //     const data = JSON.parse(event.data);
        
    //     // Assuming server sends an object like { profits: newProfitAmount }
    //     const newProfit = data.profits;
    
    //     // Update profits in the UI
    //     document.getElementById('profits').textContent = newProfit.toFixed(2);
    
    //     // Notify user about profit increment
    //     if (newProfit > previousProfit) {
    //         alert(`Your profits have increased! New profit: $${newProfit.toFixed(2)}`);
    //     }
        
    //     // Update previous profit for comparison
    //     previousProfit = newProfit;
    // };
    
    // socket.onclose = function () {
    //     console.log('Disconnected from WebSocket server');
    // };
    
    // // Fetch user data every 30 seconds (adjust as necessary)
    // setInterval(fetchUserData, 30000);
    
    // // Initial fetch to display user data on page load
    // fetchUserData();
    